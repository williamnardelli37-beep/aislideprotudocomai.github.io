<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Slide PRO 4.0</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --color-bg-start: #ff7e5f;
            --color-bg-mid: #feb47b;
            --color-bg-end: #ffcc9b;
            --color-accent: #e55a40;
            --color-text-dark: #2c3e50;
            --color-text-light: #ffffff;
            --color-primary-cta: #e99c12;
            --color-glass-bg: rgba(255, 255, 255, 0.6);
            --color-glass-border: rgba(255, 255, 255, 0.4);
            --color-glass-shadow: rgba(0, 0, 0, 0.1);
        }

        @keyframes bg-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        body { 
            min-height: 10vh;
            color: var(--color-text-dark);
            background: linear-gradient(135deg, var(--color-bg-start), var(--color-bg-mid), var(--color-bg-end));
            background-size: 400% 400%;
            animation: bg-animation 20s ease infinite;
            font-family: 'Poppins', sans-serif;
            transition: background-color 0.5s ease-in-out;
        }

        /* Beta Version Styles (Pro e Vogue) */
        body.beta-version {
            
            --color-bg-mid: #415A77;
            background-size: 400% 400%;
            
        }

        body.beta-version .glass-panel {
            background-color: var(--color-glass-bg);
            border: 1px solid var(--color-glass-border);
            box-shadow: 0 4px 30px var(--color-glass-shadow);
        }
        
        body.beta-version .btn-primary, body.beta-version .btn-secondary {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--color-text-dark);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(5px);
            font-weight: 400;
        }
        
        body.beta-version .btn-primary:hover, body.beta-version .btn-secondary:hover {
            background-color: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }

        .glass-panel {
            background-color: var(--color-glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--color-glass-border);
            box-shadow: 0 4px 30px var(--color-glass-shadow);
            transition: transform 0.3s ease-in-out, background-color 0.5s ease;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            font-weight: 700;
            border-radius: 9999px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }

        .btn-primary { 
            background-color: var(--color-primary-cta);
            color: var(--color-text-light);
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        .btn-primary:hover {
            background-color: #e68a00;
        }

        .btn-secondary { 
            background-color: transparent; 
            border: 2px solid var(--color-accent);
            color: var(--color-accent);
        }
        
        .btn-secondary:hover {
            background-color: var(--color-accent);
            color: var(--color-text-light);
        }

        body.beta-version .navigation-link {
            color: var(--color-text-dark);
        }

        body.beta-version .navigation-link:hover {
            color: var(--color-accent);
        }

        .slide-container {
            width: 100%;
            padding: 2rem;
            border-radius: 0.5rem;
            min-height: 250px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
            background-size: cover;
            background-position: center;
            background-color: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            color: var(--color-text-dark);
        }

        .slide-container.selected {
            border: 2px solid var(--color-primary-cta);
        }

        .slide-container .editable {
            outline: none;
            transition: color 0.3s ease;
        }

        .slide-container .editable:focus {
            outline: 2px solid var(--color-primary-cta);
        }

        .navigation-link { 
            transition: color 0.3s ease; 
            color: var(--color-text-dark);
            font-weight: 600;
        }

        .navigation-link:hover { 
            color: var(--color-primary-cta); 
        }

        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            transition: opacity 0.3s ease;
            opacity: 0;
            pointer-events: none;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        .modal-content {
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        .controls-hidden { opacity: 0; pointer-events: none; transition: opacity 0.5s ease-out; }

        #fullscreen-view {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--color-bg-start), var(--color-bg-mid), var(--color-bg-end));
            background-size: 400% 400%;
            animation: bg-animation 20s ease infinite;
            z-index: 1000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: none;
        }
        
        .fullscreen-slide {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 4rem;
            text-align: center;
            transition: transform 0.5s ease-in-out;
            transform-origin: center center;
            overflow-y: auto;
            color: var(--color-text-dark);
        }
        
        .fullscreen-slide.with-bg {
            background-size: cover;
            background-position: center;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }
        
        .fullscreen-controls {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .fullscreen-controls.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        .fullscreen-controls button {
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border-radius: 50%;
            padding: 1rem;
            margin: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
            pointer-events: auto;
        }
        
        .fullscreen-controls button:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }
        
        #slideCounter {
            position: absolute;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.9rem;
            pointer-events: auto;
        }

        .progress-container {
            width: 100%;
            background-color: #f3f3f3;
            border-radius: 50px;
            overflow: hidden;
            margin-top: 2rem;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }

        #progressBar {
            height: 20px;
            width: 0%;
            background-color: #4CAF50;
            text-align: center;
            line-height: 20px;
            color: white;
            transition: width 0.5s ease;
        }
        
        #laser-pointer {
            position: absolute;
            width: 15px;
            height: 15px;
            background-color: rgba(255, 0, 0, 0.8);
            border-radius: 50%;
            pointer-events: none;
            z-index: 1001;
            box-shadow: 0 0 5px 2px rgba(255, 0, 0, 0.5);
            transition: transform 0.05s ease;
            transform: translate(-50%, -50%);
        }

        /* New Chat styles */
        #chat-container {
            height: 60vh;
            display: flex;
            flex-direction: column;
            background-color: var(--color-glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--color-glass-border);
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 30px var(--color-glass-shadow);
        }

        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 1rem;
            padding-right: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .user-message, .ai-message {
            max-width: 80%;
            padding: 0.75rem;
            border-radius: 1rem;
            word-wrap: break-word;
        }
        
        .user-message {
            background-color: rgba(255, 255, 255, 0.2);
            align-self: flex-end;
            text-align: right;
            color: black;
        }
        
        .ai-message {
            background-color: rgba(0, 0, 0, 0.1);
            align-self: flex-start;
            text-align: left;
            color: black;
        }
        
        /* New styles for Virtual Assistant */
        .btn-floating {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            width: 4rem;
            height: 4rem;
            border-radius: 50%;
            background-color: var(--color-primary-cta);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
            z-index: 999;
            transition: transform 0.3s ease;
        }
        
        .btn-floating:hover {
            transform: scale(1.1);
        }
        
        .virtual-assistant-container {
            position: fixed;
            bottom: 6rem;
            right: 1.5rem;
            width: 90%;
            max-width: 400px;
            height: 60vh;
            background-color: var(--color-glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--color-glass-border);
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 30px var(--color-glass-shadow);
            z-index: 998;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease, opacity 0.3s ease;
            transform: translateY(20px);
            opacity: 0;
            pointer-events: none;
        }
        
        .virtual-assistant-container.active {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
        }
    </style>
</head>
<body class="beta-version">
    <header class="fixed w-full z-20 py-6">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <a href="#" class="text-3xl font-bold">AI Slide <span class="text-[#007BFF]">PRO</span></a>
            <div class="flex space-x-6 items-center">
                <div class="flex flex-col items-end">
                    <span id="clock" class="text-xl font-bold"></span>
                    <span id="timeSpent" class="text-xs text-gray-600"></span>
                </div>
                <nav class="flex space-x-6">
                    <button id="navLogin" class="navigation-link">Entrar</button>
                    <button id="navGenerate" class="navigation-link">Gerar</button>
                    <button id="navDashboard" class="navigation-link">Dashboard</button>
                    <button id="navGeneral" class="navigation-link">Atualiza√ß√µes 4.0</button>
                    <button id="navChat" class="navigation-link hidden">Chat GPT</button>
                    <button id="presentationModeBtn" class="navigation-link hidden">Apresentar</button>
                </nav>
            </div>
            <div id="language-switcher" class="flex items-center space-x-2 hidden">
                <button id="lang-pt" class="btn btn-secondary text-sm">PT</button>
                <button id="lang-en" class="btn btn-secondary text-sm">EN</button>
            </div>
        </div>
    </header>

    <main class="flex-grow flex items-center justify-center pt-28 pb-12">
        <div id="main-content" class="container mx-auto px-4 max-w-6xl w-full">
            
            <section id="login-panel" class="main-panel">
                <div class="glass-panel p-12 rounded-lg max-w-lg mx-auto text-center">
                    <h2 class="text-4xl font-bold mb-8" data-i18n="login-title">Liberte Sua Criatividade!</h2>
                    <p class="mb-8" data-i18n="login-subtitle">Entre para criar, aprender e inspirar. Seu pr√≥ximo grande projeto come√ßa aqui.</p>
                    <div class="space-y-6 flex flex-col items-center">
                        <img id="profile-picture" src="https://via.placeholder.com/150" alt="Foto de Perfil" class="w-24 h-24 rounded-full mb-4 object-cover cursor-pointer">
                        <input type="file" id="profilePicInput" accept="image/*" class="hidden">
                        <div>
                            <label for="nameInput" class="block mb-2 text-sm font-semibold text-center" data-i18n="login-name-label">Seu Nome</label>
                            <input type="text" id="nameInput" class="w-full p-3 bg-transparent border-b border-gray-400 focus:outline-none focus:border-gray-600 text-center" placeholder="Seu nome">
                        </div>
                    </div>
                    <div class="flex justify-center space-x-4 mt-8">
                        <button id="loginBtn" class="btn btn-primary" data-i18n="login-btn">Entrar</button>
                    </div>
                    <div id="authStatus" class="mt-6 text-center text-red-600"></div>
                </div>
            </section>

            <section id="generation-panel" class="main-panel hidden">
                <div class="glass-panel p-12 rounded-lg max-w-2xl mx-auto text-center">
                    <h2 class="text-4xl font-bold mb-8" data-i18n="generate-title">Crie com a Intelig√™ncia Artificial!</h2>
                    <div class="mb-6">
                        <textarea id="promptInput" class="w-full h-32 p-4 bg-transparent border border-gray-400 rounded-lg focus:outline-none focus:border-gray-600 transition-colors" data-i18n="generate-placeholder"></textarea>
                    </div>
                    <button id="generateBtn" class="btn btn-primary w-full max-w-xs mx-auto" data-i18n="generate-btn">Gerar Slides</button>
                    <div id="statusMessage" class="flex items-center justify-center mt-4 text-sm text-gray-500">
                        <svg id="loadingIcon" class="hidden animate-spin h-5 w-5 mr-3 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span id="statusText" data-i18n="generate-status-text"></span>
                    </div>
                </div>
            </section>

            <section id="user-dashboard" class="main-panel hidden">
                <div class="glass-panel p-12 rounded-lg text-center">
                    <div class="flex flex-col items-center mb-6">
                        <img id="dashboardProfilePic" src="https://via.placeholder.com/150" alt="Foto de Perfil do Usu√°rio" class="w-32 h-32 rounded-full mb-4 object-cover">
                        <button id="changeProfilePicBtn" class="btn btn-secondary text-sm px-4 py-2" data-i18n="dashboard-change-pic-btn">Mudar Foto</button>
                    </div>
                    <h2 class="text-4xl font-bold mb-4" data-i18n="dashboard-title">Meus Projetos </h2>
                    <p id="usernameDisplay" class="text-lg mb-8 text-gray-500"></p>
                    <div id="projects-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        <p class="text-gray-500 col-span-full" data-i18n="dashboard-no-projects">Nenhum projeto salvo ainda.</p>
                    </div>
                    <div class="flex justify-center space-x-4 mt-8">
                        <button id="createProjectBtn" class="btn btn-primary" data-i18n="dashboard-new-project-btn">Novo Projeto</button>
                        <button id="uploadProjectBtn" class="btn btn-secondary" data-i18n="dashboard-upload-btn">Upload</button>
                        <input type="file" id="uploadInput" accept=".json" class="hidden">
                        <button id="logoutBtn" class="btn btn-secondary" data-i18n="dashboard-logout-btn">Sair</button>
                    </div>
                </div>
            </section>
            
            <section id="editor-area" class="main-panel hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <div class="col-span-1 md:col-span-2 lg:col-span-3 glass-panel p-6 rounded-lg flex flex-wrap items-center justify-center space-x-4 mb-8">
                        <button id="addSlideBtn" class="btn btn-secondary" data-i18n="editor-new-slide-btn">Novo Slide</button>
                        <button id="deleteSlideBtn" class="btn btn-secondary" data-i18n="editor-delete-slide-btn">Excluir Slide</button>
                        <button id="addImageBtn" class="btn btn-secondary" data-i18n="editor-add-image-btn">Adicionar Imagem</button>
                        <button id="saveProjectBtn" class="btn btn-primary" data-i18n="editor-save-btn">Salvar Projeto</button>
                        <button id="exportPdfBtn" class="btn btn-secondary hidden" data-i18n="editor-export-pdf-btn">Exportar PDF</button>
                        <button id="emailProjectBtn" class="btn btn-secondary hidden" data-i18n="editor-email-btn">Enviar por Email</button>
                    </div>
                    <div id="slides-grid" class="col-span-1 md:col-span-2 lg:col-span-3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8"></div>
                </div>
            </section>
            
            <section id="chat-panel" class="main-panel hidden">
                <div class="glass-panel p-12 rounded-lg max-w-2xl mx-auto text-center">
                    <h2 class="text-4xl font-bold mb-8" data-i18n="chat-title">Chat M&A Pro Beta</h2>
                    <div id="chat-container">
                        <div id="chat-messages"></div>
                        <div class="flex space-x-2 mt-4">
                            <input type="text" id="chat-input" class="w-full p-3 rounded-lg bg-transparent border border-gray-400 focus:outline-none focus:border-gray-600" placeholder="Digite sua pergunta..." data-i18n="chat-placeholder">
                            <button id="send-chat-btn" class="btn btn-primary" data-i18n="chat-send-btn">Enviar</button>
                        </div>
                    </div>
                </div>
            </section>

            <section id="general-panel" class="main-panel hidden">
                <div class="glass-panel p-12 rounded-lg max-w-lg mx-auto text-center mt-12">
                    <h2 class="text-2xl font-bold mb-4" data-i18n="general-title">Atualiza√ß√µes</h2>
                    <p class="mb-4" data-i18n="general-version">Vers√£o do Sistema: <span id="currentVersion">4.1 Beta</span></p>
                    <div class="text-left mt-6">
                        <p class="font-bold text-lg text-white mb-2">üéâ Uma Nova Experi√™ncia Chegou!</p>
                        <p class="text-sm mb-4">Estamos orgulhosos de apresentar a **vers√£o 4.0 Beta**, uma atualiza√ß√£o focada em tornar a sua experi√™ncia de cria√ß√£o ainda mais fluida e agrad√°vel.</p>
                        <p class="font-bold mt-4 text-white">‚ú® O Que H√° de Novo?</p>
                        <ul class="list-disc list-inside text-sm">
                            <li><strong>Design Renovado:</strong> Uma interface completamente nova, com bot√µes de efeito transparente e um fundo animado em tons de azul para uma navega√ß√£o visualmente impressionante.</li>
                            <li><strong>Chat M&A Pro Beta:</strong> Um novo assistente de IA integrado, mais r√°pido e preciso, pronto para responder √†s suas perguntas e ajudar na sua pesquisa em tempo real.</li>
                            <li><strong>Otimiza√ß√£o de Performance:</strong> Diversas melhorias internas para garantir um desempenho mais r√°pido e est√°vel, desde a gera√ß√£o de slides at√© o modo de apresenta√ß√£o.</li>
                        </ul>
                    </div>
                    <div id="updateStatus" class="mt-4 hidden">
                        <p id="updateMessage" data-i18n="general-updating">Atualizando...</p>
                        <div class="progress-container">
                            <div id="progressBar"></div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <footer class="text-center py-4 text-gray-500 text-sm">
        <p data-i18n="footer-copyright">&copy; 2025 AI Slide PRO 4.0. Todos os direitos reservados.</p>
    </footer>

    <div id="imageModal" class="modal-overlay fixed inset-0 flex items-center justify-center z-50">
        <div class="glass-panel p-8 rounded-lg max-w-2xl w-full text-black modal-content">
            <h3 class="text-3xl font-bold mb-4 text-center" data-i18n="image-modal-title">Adicionar Imagem</h3>
            <div class="flex space-x-2 mb-4">
                <input type="text" id="imageSearchInput" class="w-full p-3 bg-transparent border-b border-gray-400 focus:outline-none focus:border-gray-600" placeholder="Buscar imagens..." data-i18n="image-modal-placeholder">
                <button id="searchImageBtn" class="btn btn-primary" data-i18n="image-modal-search-btn">Buscar</button>
            </div>
            <div id="imageResults" class="grid grid-cols-2 sm:grid-cols-3 gap-4 max-h-60 overflow-y-auto mt-4"></div>
            <div class="flex justify-end mt-6">
                <button id="closeImageModalBtn" class="btn btn-secondary" data-i18n="image-modal-close-btn">Fechar</button>
            </div>
        </div>
    </div>
    
    <div id="fullscreen-view" class="hidden">
        <div id="slides-carousel" class="relative w-full h-full flex items-center justify-center overflow-hidden"></div>
        <div id="laser-pointer" class="hidden"></div>
        <div class="fullscreen-controls hidden">
            <button id="prevBtn" class="prev-next-btn">
                <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
            </button>
            <button id="nextBtn" class="prev-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
            </button>
            <button id="exitFullscreenBtn" class="absolute top-4 right-4">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <span id="slideCounter"></span>
        </div>
    </div>
    
    <button id="virtualAssistantBtn" class="btn-floating">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8">
            <path d="M4.912 2.872a.75.75 0 0 0-.214 1.056l1.455 2.518a24.583 24.583 0 0 1-.771 5.185l-1.454 2.518a.75.75 0 0 0 .214 1.056l1.205.696a24.57 24.57 0 0 1 1.79-1.577 24.57 24.57 0 0 1 1.577 1.79l-.696 1.205a.75.75 0 0 0 1.056.214l2.518-1.454a24.583 24.583 0 0 1 5.185.771l2.518 1.455a.75.75 0 0 0 1.056-.214l.696-1.205a24.57 24.57 0 0 1-1.577-1.79c.12-.224.23-.454.332-.693a.75.75 0 0 0-.584-1.157l-2.518-.696A24.583 24.583 0 0 1 12 6.545V4.75a.75.75 0 0 0-1.5 0v1.795a24.583 24.583 0 0 1-5.185.771L3.196 2.658a.75.75 0 0 0-1.056.214Z" />
        </svg>
    </button>
    
    <div id="virtualAssistantContainer" class="virtual-assistant-container">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold" data-i18n="va-title">Assistente Virtual</h3>
            <button id="closeVaBtn" class="text-gray-500 hover:text-gray-800">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div id="va-messages" class="flex-grow overflow-y-auto mb-4 p-2 rounded-lg bg-gray-100 dark:bg-gray-800"></div>
        <div class="flex space-x-2">
            <input type="text" id="va-input" class="w-full p-3 rounded-lg bg-transparent border border-gray-400 focus:outline-none focus:border-gray-600" placeholder="Digite sua pergunta..." data-i18n="chat-placeholder">
            <button id="va-send-btn" class="btn btn-primary px-4 py-2" data-i18n="chat-send-btn">Enviar</button>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_KEY_GEMINI = "AIzaSyDfnepNXRHT2CDUgg9n3v6ej5IV2O3ohiI"; 
            const API_KEY_PEXELS = "qBVmIu4GKw8cv85GznG0UuKzZLc9CDxmGRnOJTm3H1M8OQPR0rrC9fDl"; 

            const navLogin = document.getElementById('navLogin');
            const navGenerate = document.getElementById('navGenerate');
            const navDashboard = document.getElementById('navDashboard');
            const navGeneral = document.getElementById('navGeneral');
            const navChat = document.getElementById('navChat');
            const loginPanel = document.getElementById('login-panel');
            const generationPanel = document.getElementById('generation-panel');
            const userDashboard = document.getElementById('user-dashboard');
            const editorArea = document.getElementById('editor-area');
            const generalPanel = document.getElementById('general-panel');
            const chatPanel = document.getElementById('chat-panel');

            const promptInput = document.getElementById('promptInput');
            const generateBtn = document.getElementById('generateBtn');
            const statusMessage = document.getElementById('statusMessage');
            const loadingIcon = document.getElementById('loadingIcon');
            const statusText = document.getElementById('statusText');
            const slidesGrid = document.getElementById('slides-grid');
            
            const nameInput = document.getElementById('nameInput');
            const loginBtn = document.getElementById('loginBtn');
            const authStatus = document.getElementById('authStatus');
            const createProjectBtn = document.getElementById('createProjectBtn');
            const saveProjectBtn = document.getElementById('saveProjectBtn');
            const uploadProjectBtn = document.getElementById('uploadProjectBtn');
            const uploadInput = document.getElementById('uploadInput');
            const logoutBtn = document.getElementById('logoutBtn');
            const usernameDisplay = document.getElementById('usernameDisplay');

            const addSlideBtn = document.getElementById('addSlideBtn');
            const deleteSlideBtn = document.getElementById('deleteSlideBtn');
            const addImageBtn = document.getElementById('addImageBtn');
            const imageModal = document.getElementById('imageModal');
            const closeImageModalBtn = document.getElementById('closeImageModalBtn');
            const imageSearchInput = document.getElementById('imageSearchInput');
            const searchImageBtn = document.getElementById('searchImageBtn');
            const imageResults = document.getElementById('imageResults');
            
            const clock = document.getElementById('clock');
            const timeSpent = document.getElementById('timeSpent');

            // Fullscreen Presentation Mode elements
            const presentationModeBtn = document.getElementById('presentationModeBtn');
            const fullscreenView = document.getElementById('fullscreen-view');
            const slidesCarousel = document.getElementById('slides-carousel');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const exitFullscreenBtn = document.getElementById('exitFullscreenBtn');
            const slideCounter = document.getElementById('slideCounter');
            const fullscreenControls = document.querySelector('.fullscreen-controls');
            const laserPointer = document.getElementById('laser-pointer');
            let laserTimeout;

            // New elements
            const exportPdfBtn = document.getElementById('exportPdfBtn');
            const emailProjectBtn = document.getElementById('emailProjectBtn');
            const currentVersion = document.getElementById('currentVersion');

            // Profile Picture elements
            const profilePicture = document.getElementById('profile-picture');
            const profilePicInput = document.getElementById('profilePicInput');
            const dashboardProfilePic = document.getElementById('dashboardProfilePic');
            const changeProfilePicBtn = document.getElementById('changeProfilePicBtn');

            // Chat elements
            const chatInput = document.getElementById('chat-input');
            const sendChatBtn = document.getElementById('send-chat-btn');
            const chatMessages = document.getElementById('chat-messages');
            
            // New Virtual Assistant elements
            const virtualAssistantBtn = document.getElementById('virtualAssistantBtn');
            const virtualAssistantContainer = document.getElementById('virtualAssistantContainer');
            const closeVaBtn = document.getElementById('closeVaBtn');
            const vaInput = document.getElementById('va-input');
            const vaSendBtn = document.getElementById('va-send-btn');
            const vaMessages = document.getElementById('va-messages');


            // Language elements
            const languageSwitcher = document.getElementById('language-switcher');
            const langPtBtn = document.getElementById('lang-pt');
            const langEnBtn = document.getElementById('lang-en');
            let currentLanguage = localStorage.getItem('currentLanguage') || 'pt';
            
            const translations = {
                'pt': {
                    'login-title': 'Liberte Sua Criatividade!',
                    'login-subtitle': 'Entre para criar, aprender e inspirar. Seu pr√≥ximo grande projeto come√ßa aqui.',
                    'login-name-label': 'Seu Nome de Estudante',
                    'login-btn': 'Entrar',
                    'generate-title': 'Crie com a Intelig√™ncia Artificial!',
                    'generate-btn': 'Gerar Slides',
                    'generate-status-text': 'Aguarde, a IA est√° trabalhando...',
                    'dashboard-change-pic-btn': 'Mudar Foto',
                    'dashboard-title': 'Meus Projetos de Estudo',
                    'dashboard-no-projects': 'Nenhum projeto salvo ainda.',
                    'dashboard-new-project-btn': 'Novo Projeto',
                    'dashboard-upload-btn': 'Upload',
                    'dashboard-logout-btn': 'Sair',
                    'editor-new-slide-btn': 'Novo Slide',
                    'editor-delete-slide-btn': 'Excluir Slide',
                    'editor-add-image-btn': 'Adicionar Imagem',
                    'editor-save-btn': 'Salvar Projeto',
                    'editor-export-pdf-btn': 'Exportar PDF',
                    'editor-email-btn': 'Enviar por Email',
                    'chat-title': 'Chat M&A Pro Beta',
                    'chat-placeholder': 'Digite sua pergunta...',
                    'chat-send-btn': 'Enviar',
                    'general-title': 'Atualiza√ß√µes',
                    'general-version': 'Vers√£o do Sistema: ',
                    'general-updating': 'Atualizando...',
                    'footer-copyright': '&copy; 2023 AI Slide PRO. Todos os direitos reservados.',
                    'nav-login': 'Entrar',
                    'nav-generate': 'Gerar',
                    'nav-dashboard': 'Dashboard',
                    'nav-general': 'Atualiza√ß√µes',
                    'nav-chat': 'Chat',
                    'nav-present': 'Apresentar',
                    'image-modal-title': 'Adicionar Imagem',
                    'image-modal-placeholder': 'Buscar imagens...',
                    'image-modal-search-btn': 'Buscar',
                    'image-modal-close-btn': 'Fechar',
                    'va-title': 'Assistente Virtual',
                },
                'en': {
                    'login-title': 'Unleash Your Creativity!',
                    'login-subtitle': 'Log in to create, learn, and inspire. Your next big project starts here.',
                    'login-name-label': 'Your Student Name',
                    'login-btn': 'Log In',
                    'generate-title': 'Create with Artificial Intelligence!',
                    'generate-btn': 'Generate Slides',
                    'generate-status-text': 'Please wait, the AI is working...',
                    'dashboard-change-pic-btn': 'Change Photo',
                    'dashboard-title': 'My Study Projects',
                    'dashboard-no-projects': 'No projects saved yet.',
                    'dashboard-new-project-btn': 'New Project',
                    'dashboard-upload-btn': 'Upload',
                    'dashboard-logout-btn': 'Log Out',
                    'editor-new-slide-btn': 'New Slide',
                    'editor-delete-slide-btn': 'Delete Slide',
                    'editor-add-image-btn': 'Add Image',
                    'editor-save-btn': 'Save Project',
                    'editor-export-pdf-btn': 'Export PDF',
                    'editor-email-btn': 'Send by Email',
                    'chat-title': 'Chat M&A Pro Beta',
                    'chat-placeholder': 'Type your question...',
                    'chat-send-btn': 'Send',
                    'general-title': 'Updates',
                    'general-version': 'System Version: ',
                    'general-updating': 'Updating...',
                    'footer-copyright': '&copy; 2023 AI Slide PRO. All rights reserved.',
                    'nav-login': 'Log In',
                    'nav-generate': 'Generate',
                    'nav-dashboard': 'Dashboard',
                    'nav-general': 'Updates',
                    'nav-chat': 'Chat',
                    'nav-present': 'Present',
                    'image-modal-title': 'Add Image',
                    'image-modal-placeholder': 'Search images...',
                    'image-modal-search-btn': 'Search',
                    'image-modal-close-btn': 'Close',
                    'va-title': 'Virtual Assistant',
                }
            };
            
            const updateTexts = () => {
                const elementsToTranslate = document.querySelectorAll('[data-i18n]');
                elementsToTranslate.forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if (translations[currentLanguage][key]) {
                        el.textContent = translations[currentLanguage][key];
                    }
                });
                
                // Special cases for elements with placeholders or custom text
                if (currentLanguage === 'en') {
                    nameInput.placeholder = 'Your name';
                    chatInput.placeholder = 'Type your question...';
                    vaInput.placeholder = 'Type your question...';
                } else {
                    nameInput.placeholder = 'Seu nome';
                    chatInput.placeholder = 'Digite sua pergunta...';
                    vaInput.placeholder = 'Digite sua pergunta...';
                }
            };

            const toggleLanguage = (lang) => {
                currentLanguage = lang;
                localStorage.setItem('currentLanguage', lang);
                updateTexts();
            };

            langPtBtn.addEventListener('click', () => toggleLanguage('pt'));
            langEnBtn.addEventListener('click', () => toggleLanguage('en'));


            let presentation = {
                slides: [],
                activeSlideIndex: -1,
            };
            let currentUser = null;
            let userProjects = [];
            let controlsTimeout;
            let totalTimeInSeconds = parseInt(localStorage.getItem('totalTimeInSeconds')) || 0;
            let startTime = Date.now();
            let timerInterval;

            const showPanel = (panelId) => {
                const panels = [loginPanel, generationPanel, userDashboard, editorArea, generalPanel, chatPanel];
                panels.forEach(panel => panel.classList.add('hidden'));
                const targetPanel = document.getElementById(panelId);
                if (targetPanel) {
                    targetPanel.classList.remove('hidden');
                }
                presentationModeBtn.classList.toggle('hidden', panelId !== 'editor-area' || presentation.slides.length === 0);
            };
            
            navLogin.addEventListener('click', () => {
                showPanel('login-panel');
            });
            navGenerate.addEventListener('click', () => {
                showPanel('generation-panel');
            });
            navDashboard.addEventListener('click', () => {
                if (currentUser) {
                    showPanel('user-dashboard');
                    renderProjectsList();
                } else {
                    alert("Por favor, fa√ßa login para acessar o Dashboard.");
                    showPanel('login-panel');
                }
            });
            navGeneral.addEventListener('click', () => {
                showPanel('general-panel');
            });
            navChat.addEventListener('click', () => {
                showPanel('chat-panel');
            });


            const renderSlidesGrid = () => {
                slidesGrid.innerHTML = '';
                presentation.slides.forEach((slide, index) => {
                    const slideElement = document.createElement('div');
                    slideElement.dataset.index = index; 
                    
                    const isSelected = index === presentation.activeSlideIndex;
                    
                    slideElement.className = `slide-container ${isSelected ? 'selected' : ''}`;
                    
                    if (slide.backgroundImage) {
                        slideElement.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url(${slide.backgroundImage})`;
                        slideElement.style.color = '#fff';
                    } else {
                         slideElement.style.backgroundImage = 'none';
                         slideElement.style.color = 'var(--color-text-dark)';
                    }
                    
                    const titleClass = `text-2xl font-bold mb-4 editable`;
                    const bodyClass = `text-sm leading-relaxed whitespace-pre-wrap editable`;

                    slideElement.innerHTML = `
                        <h2 contenteditable="true" class="${titleClass}">${slide.title}</h2>
                        <p contenteditable="true" class="${bodyClass}">${slide.body}</p>
                    `;
                    
                    const editableElements = slideElement.querySelectorAll('[contenteditable="true"]');
                    editableElements.forEach(el => {
                        el.addEventListener('input', () => {
                            const newText = el.innerHTML;
                            if (el.tagName === 'H2') {
                                presentation.slides[index].title = newText;
                            } else if (el.tagName === 'P') {
                                presentation.slides[index].body = newText;
                            }
                        });
                    });

                    slidesGrid.appendChild(slideElement);
                });
                presentationModeBtn.classList.toggle('hidden', presentation.slides.length === 0);
            };

            const generateSlides = async () => {
                const prompt = promptInput.value.trim();
                if (!prompt) {
                    statusText.textContent = currentLanguage === 'en' ? "Please enter a topic to generate the slides." : "Por favor, digite um t√≥pico para gerar os slides.";
                    return;
                }
                showPanel('editor-area');
                generateBtn.disabled = true;
                generateBtn.textContent = currentLanguage === 'en' ? 'Generating...' : 'Gerando...';
                loadingIcon.classList.remove('hidden');
                statusText.textContent = currentLanguage === 'en' ? 'Please wait, the AI is working...' : 'Aguarde, a IA est√° trabalhando...';
                
                presentation.slides = [];

                try {
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY_GEMINI}`;

                    const ptPrompt = `Crie um conte√∫do de slides detalhado e bem estruturado sobre o seguinte t√≥pico: "${prompt}". Para cada slide, forne√ßa um t√≠tulo claro e um corpo de texto. Adicione uma sugest√£o de imagem (em ingl√™s) para cada slide. Separe cada slide com duas quebras de linha. Responda apenas com o texto, sem formata√ß√£o extra como asteriscos ou cabe√ßalhos.
                    Exemplo de resposta:
                    Slide 1: Introdu√ß√£o ao T√≥pico
                    Ponto 1
                    Ponto 2
                    Sugest√£o de imagem: image of a computer
                    
                    Slide 2: T√≠tulo do Slide
                    Ponto 1
                    Ponto 2
                    Sugest√£o de imagem: image of a sunset`;

                    const enPrompt = `Create a detailed and well-structured slide content on the following topic: "${prompt}". For each slide, provide a clear title and body text. Add an image suggestion (in English) for each slide. Separate each slide with two line breaks. Respond only with the text, without extra formatting like asterisks or headings.
                    Example response:
                    Slide 1: Introduction to the Topic
                    Point 1
                    Point 2
                    Image suggestion: image of a computer
                    
                    Slide 2: Slide Title
                    Point 1
                    Point 2
                    Image suggestion: image of a sunset`;

                    const selectedPrompt = currentLanguage === 'en' ? enPrompt : ptPrompt;

                    const textPayload = {
                        contents: [{
                            parts: [{ text: selectedPrompt }]
                        }]
                    };
                    const textResponse = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(textPayload)
                    });
                    if (!textResponse.ok) {
                        throw new Error(`Error generating slide text.`);
                    }
                    const textResult = await textResponse.json();
                    const responseText = textResult.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!responseText) {
                        statusText.textContent = currentLanguage === 'en' ? 'The API did not return text content. Try a different topic.' : 'A API n√£o retornou conte√∫do de texto. Tente um t√≥pico diferente.';
                        return;
                    }

                    const slideContents = responseText.replace(/\*/g, '').trim().split('\n\n').filter(p => p.trim() !== '');
                    if (slideContents.length === 0) {
                        statusText.textContent = currentLanguage === 'en' ? 'No slides were generated. Try a different topic.' : 'Nenhum slide foi gerado. Tente um t√≥pico diferente.';
                        return;
                    }

                    slideContents.forEach((content) => {
                        const lines = content.split('\n');
                        const titleLine = lines[0];
                        const bodyLines = lines.slice(1).filter(line => !line.includes('Sugest√£o de imagem:') && !line.includes('Image suggestion:'));
                        const title = titleLine.replace(/Slide \d+: /, '').replace(/Slide \d+:/, '').trim();
                        const body = bodyLines.map(line => line.trim()).join('\n');
                        const imageSuggestion = lines.find(line => line.includes('Sugest√£o de imagem:') || line.includes('Image suggestion:'))?.replace('Sugest√£o de imagem:', '').replace('Image suggestion:', '').trim();

                        presentation.slides.push({ title, body, backgroundImage: null, imageSuggestion });
                    });
                    
                    statusText.textContent = currentLanguage === 'en' ? 'Slides generated successfully!' : 'Slides gerados com sucesso!';
                    presentation.activeSlideIndex = 0;
                    renderSlidesGrid();

                } catch (error) {
                    console.error('Erro na requisi√ß√£o:', error);
                    statusText.textContent = currentLanguage === 'en' ? `Error: ${error.message}` : `Erro: ${error.message}`;
                } finally {
                    generateBtn.disabled = false;
                    generateBtn.textContent = currentLanguage === 'en' ? 'Generate Slides' : 'Gerar Slides';
                    loadingIcon.classList.add('hidden');
                }
            };
            
            const addSlide = () => {
                const newSlide = {
                    title: currentLanguage === 'en' ? 'New Slide' : 'Novo Slide',
                    body: currentLanguage === 'en' ? 'Click to edit text...' : 'Clique para editar o texto...',
                    backgroundImage: null,
                    imageSuggestion: null,
                };
                presentation.slides.push(newSlide);
                presentation.activeSlideIndex = presentation.slides.length - 1;
                renderSlidesGrid();
            };
            
            const deleteSlide = () => {
                if (presentation.slides.length > 0 && presentation.activeSlideIndex > -1) {
                    presentation.slides.splice(presentation.activeSlideIndex, 1);
                    presentation.activeSlideIndex = Math.min(presentation.activeSlideIndex, presentation.slides.length - 1);
                    renderSlidesGrid();
                }
            };

            const searchImages = async (query) => {
                if (!query) return;
                const url = `https://api.pexels.com/v1/search?query=${encodeURIComponent(query)}&per_page=12`;
                try {
                    const response = await fetch(url, {
                        headers: { 'Authorization': API_KEY_PEXELS }
                    });
                    const data = await response.json();
                    imageResults.innerHTML = '';
                    data.photos.forEach(photo => {
                        const img = document.createElement('img');
                        img.src = photo.src.medium;
                        img.className = 'w-full h-24 object-cover rounded-md cursor-pointer hover:scale-105 transition-transform';
                        img.addEventListener('click', () => {
                            if (presentation.activeSlideIndex > -1) {
                                presentation.slides[presentation.activeSlideIndex].backgroundImage = photo.src.original;
                                imageModal.classList.remove('active');
                                renderSlidesGrid();
                            }
                        });
                        imageResults.appendChild(img);
                    });
                } catch (error) {
                    console.error('Erro ao buscar imagens:', error);
                    alert(currentLanguage === 'en' ? 'Failed to search for images. Please try again.' : 'Falha ao buscar imagens. Tente novamente.');
                }
            };

            const saveProject = () => {
                if (!currentUser) {
                    alert(currentLanguage === 'en' ? "Please log in to save the project." : "Por favor, fa√ßa login para salvar o projeto.");
                    return;
                }
                if (presentation.slides.length === 0) {
                    alert(currentLanguage === 'en' ? "There are no slides to save." : "N√£o h√° slides para salvar.");
                    return;
                }
                
                const projectName = prompt(currentLanguage === 'en' ? "Enter a name for your project:" : "Digite um nome para o seu projeto:");
                if (!projectName) {
                    alert(currentLanguage === 'en' ? "Project name is required." : "Nome do projeto √© obrigat√≥rio.");
                    return;
                }

                const newProject = {
                    id: Date.now(),
                    name: projectName,
                    slides: presentation.slides,
                    createdAt: new Date().toISOString()
                };

                userProjects.push(newProject);
                localStorage.setItem(`aiSlideProjects_${currentUser.name}`, JSON.stringify(userProjects));
                alert(currentLanguage === 'en' ? `Project "${projectName}" saved successfully!` : `Projeto "${projectName}" salvo com sucesso!`);
                renderProjectsList();
            };

            const loadProjectsFromLocalStorage = (userName) => {
                const savedProjects = localStorage.getItem(`aiSlideProjects_${userName}`);
                userProjects = savedProjects ? JSON.parse(savedProjects) : [];
            };

            const renderProjectsList = () => {
                const projectsList = document.getElementById('projects-list');
                projectsList.innerHTML = '';
                if (userProjects.length === 0) {
                    projectsList.innerHTML = `<p class="text-gray-500 col-span-full" data-i18n="dashboard-no-projects">${currentLanguage === 'en' ? 'No projects saved yet.' : 'Nenhum projeto salvo ainda.'}</p>`;
                } else {
                    userProjects.forEach(project => {
                        const projectCard = document.createElement('div');
                        projectCard.className = 'glass-panel p-6 rounded-lg text-left cursor-pointer transition-transform hover:scale-105 relative';
                        projectCard.innerHTML = `
                            <h3 class="text-xl font-bold mb-2">${project.name}</h3>
                            <p class="text-gray-500 text-sm">${project.slides.length} slides</p>
                            <div class="flex space-x-2 mt-4">
                                <button class="btn btn-secondary text-xs px-4 py-2 download-btn" data-project-id="${project.id}">${currentLanguage === 'en' ? 'Download' : 'Baixar'}</button>
                            </div>
                        `;
                        projectCard.addEventListener('click', (e) => {
                            if (!e.target.classList.contains('download-btn')) {
                                presentation.slides = project.slides;
                                presentation.activeSlideIndex = 0;
                                renderSlidesGrid();
                                showPanel('editor-area');
                            }
                        });
                        projectsList.appendChild(projectCard);
                    });
                }
            };
            
            const downloadProjectAsJson = (project) => {
                const dataStr = JSON.stringify(project, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `${project.name.replace(/[^a-z0-9]/gi, '_')}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            const handleLogout = () => {
                localStorage.removeItem('aiSlideCurrentUser');
                currentUser = null;
                presentation = { slides: [], activeSlideIndex: -1 };
                userProjects = [];
                showPanel('login-panel');
            };

            loginBtn.addEventListener('click', () => {
                const name = nameInput.value;
                if (!name) {
                    authStatus.textContent = currentLanguage === 'en' ? 'Please enter your name.' : 'Por favor, digite seu nome.';
                    return;
                }
                const profilePic = profilePicture.src;
                currentUser = { name: name, profilePic: profilePic };
                localStorage.setItem('aiSlideCurrentUser', JSON.stringify(currentUser));
                loadProjectsFromLocalStorage(currentUser.name);
                authStatus.textContent = '';
                showPanel('user-dashboard');
                usernameDisplay.textContent = currentLanguage === 'en' ? `Welcome, ${currentUser.name}!` : `Bem-vindo(a), ${currentUser.name}!`;
                dashboardProfilePic.src = currentUser.profilePic;
            });

            profilePicture.addEventListener('click', () => {
                profilePicInput.click();
            });

            changeProfilePicBtn.addEventListener('click', () => {
                profilePicInput.click();
            });
            
            profilePicInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const imageUrl = e.target.result;
                        profilePicture.src = imageUrl;
                        if (currentUser) {
                            currentUser.profilePic = imageUrl;
                            localStorage.setItem('aiSlideCurrentUser', JSON.stringify(currentUser));
                            dashboardProfilePic.src = imageUrl;
                        }
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Chat M&A Logic
            const addChatMessage = (text, sender, target) => {
                const messageDiv = document.createElement('div');
                messageDiv.className = sender === 'user' ? 'user-message' : 'ai-message';
                messageDiv.textContent = text;
                target.appendChild(messageDiv);
                target.scrollTop = target.scrollHeight; // Auto-scroll
            };

            const getChatResponse = async (query) => {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY_GEMINI}`;

                const ptChatPrompt = `Responda a esta pergunta de forma concisa e √∫til, como um assistente de IA: "${query}"`;
                const enChatPrompt = `Answer this question concisely and usefully, like an AI assistant: "${query}"`;
                const selectedChatPrompt = currentLanguage === 'en' ? enChatPrompt : ptChatPrompt;

                const payload = {
                    contents: [{
                        parts: [
                            { text: selectedChatPrompt }
                        ]
                    }]
                };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    return result.candidates?.[0]?.content?.parts?.[0]?.text || (currentLanguage === 'en' ? "Sorry, I couldn't get a response. Please try again." : "Desculpe, n√£o consegui obter uma resposta. Tente novamente.");
                } catch (error) {
                    console.error("Erro ao chamar a API do Gemini:", error);
                    return currentLanguage === 'en' ? "Sorry, a connection error occurred. Please try again later." : "Desculpe, ocorreu um erro de conex√£o. Tente novamente mais tarde.";
                }
            };

            const sendChat = async () => {
                const query = chatInput.value.trim();
                if (!query) return;

                addChatMessage(query, 'user', chatMessages);
                chatInput.value = '';

                const aiResponse = await getChatResponse(query);
                addChatMessage(aiResponse, 'ai', chatMessages);
            };

            // Text-to-speech function
            const speakText = (text) => {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = currentLanguage === 'en' ? 'en-US' : 'pt-BR';
                    window.speechSynthesis.speak(utterance);
                } else {
                    console.warn("API de fala n√£o suportada neste navegador.");
                }
            };

            const sendVaChat = async () => {
                const query = vaInput.value.trim();
                if (!query) return;
            
                addChatMessage(query, 'user', vaMessages);
                vaInput.value = '';
            
                const aiResponse = await getChatResponse(query);
                addChatMessage(aiResponse, 'ai', vaMessages);
                speakText(aiResponse); // Added call to speakText
            };
            
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendChat();
                }
            });
            sendChatBtn.addEventListener('click', sendChat);
            
            vaInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendVaChat();
                }
            });
            vaSendBtn.addEventListener('click', sendVaChat);
            
            virtualAssistantBtn.addEventListener('click', () => {
                virtualAssistantContainer.classList.toggle('active');
            });
            closeVaBtn.addEventListener('click', () => {
                virtualAssistantContainer.classList.remove('active');
            });


            logoutBtn.addEventListener('click', handleLogout);
            createProjectBtn.addEventListener('click', () => showPanel('generation-panel'));
            uploadProjectBtn.addEventListener('click', () => uploadInput.click());

            uploadInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const project = JSON.parse(e.target.result);
                        if (project && project.slides) {
                            presentation.slides = project.slides;
                            presentation.activeSlideIndex = 0;
                            renderSlidesGrid();
                            showPanel('editor-area');
                            alert(currentLanguage === 'en' ? 'Project loaded successfully!' : 'Projeto carregado com sucesso!');
                        } else {
                            alert(currentLanguage === 'en' ? 'Invalid file. Make sure to upload a valid JSON project file.' : 'Arquivo inv√°lido. Certifique-se de carregar um arquivo de projeto JSON v√°lido.');
                        }
                    } catch (error) {
                        console.error('Erro ao ler ou analisar o arquivo JSON:', error);
                        alert(currentLanguage === 'en' ? 'Error loading file. The file may be corrupted or is not a valid JSON.' : 'Erro ao carregar o arquivo. O arquivo pode estar corrompido ou n√£o √© um JSON v√°lido.');
                    }
                };
                reader.readAsText(file);
            });
            
            document.addEventListener('click', (e) => {
                const slideElement = e.target.closest('.slide-container');
                if (slideElement) {
                    const index = parseInt(slideElement.dataset.index);
                    presentation.activeSlideIndex = index;
                    renderSlidesGrid();
                }
                const downloadBtn = e.target.closest('.download-btn');
                if (downloadBtn) {
                    const projectId = parseInt(downloadBtn.dataset.projectId);
                    const project = userProjects.find(p => p.id === projectId);
                    if (project) {
                        downloadProjectAsJson(project);
                    }
                }
            });

            generateBtn.addEventListener('click', generateSlides);
            addSlideBtn.addEventListener('click', addSlide);
            deleteSlideBtn.addEventListener('click', deleteSlide);
            saveProjectBtn.addEventListener('click', saveProject);
            
            addImageBtn.addEventListener('click', () => {
                if (presentation.activeSlideIndex === -1) {
                    alert(currentLanguage === 'en' ? "Select a slide to add the image to." : "Selecione um slide para adicionar a imagem.");
                    return;
                }
                imageModal.classList.add('active');
                const activeSlide = presentation.slides[presentation.activeSlideIndex];
                if (activeSlide && activeSlide.imageSuggestion) {
                    imageSearchInput.value = activeSlide.imageSuggestion;
                    searchImages(activeSlide.imageSuggestion);
                }
            });
            closeImageModalBtn.addEventListener('click', () => imageModal.classList.remove('active'));
            imageSearchInput.addEventListener('keypress', (e) => {
                if(e.key === 'Enter') {
                    searchImages(imageSearchInput.value);
                }
            });
            searchImageBtn.addEventListener('click', () => searchImages(imageSearchInput.value));

            const checkAuthState = () => {
                const savedUser = localStorage.getItem('aiSlideCurrentUser');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    loadProjectsFromLocalStorage(currentUser.name);
                    showPanel('user-dashboard');
                    usernameDisplay.textContent = currentLanguage === 'en' ? `Welcome, ${currentUser.name}!` : `Bem-vindo(a), ${currentUser.name}!`;
                    profilePicture.src = currentUser.profilePic;
                    dashboardProfilePic.src = currentUser.profilePic;
                } else {
                    showPanel('login-panel');
                }
            };
            checkAuthState();

            const formatTime = (seconds) => {
                const h = Math.floor(seconds / 3600);
                const m = Math.floor((seconds % 3600) / 60);
                const s = seconds % 60;
                return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            };

            const updateClock = () => {
                const now = new Date();
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                const seconds = now.getSeconds().toString().padStart(2, '0');
                clock.textContent = `${hours}:${minutes}:${seconds}`;
            };

            const updateTimeSpent = () => {
                const elapsedTime = Math.floor((Date.now() - startTime) / 1000);
                const currentTotal = totalTimeInSeconds + elapsedTime;
                timeSpent.textContent = currentLanguage === 'en' ? `Total time: ${formatTime(currentTotal)}` : `Tempo total: ${formatTime(currentTotal)}`;
            };

            updateClock();
            setInterval(updateClock, 1000);

            updateTimeSpent();
            timerInterval = setInterval(updateTimeSpent, 1000);

            window.addEventListener('beforeunload', () => {
                const sessionTime = Math.floor((Date.now() - startTime) / 1000);
                totalTimeInSeconds += sessionTime;
                localStorage.setItem('totalTimeInSeconds', totalTimeInSeconds);
            });
            
            // Initial UI state setup for Beta version
            document.body.classList.add('beta-version');
            currentVersion.textContent = '4.1 Beta';
            exportPdfBtn.classList.remove('hidden');
            emailProjectBtn.classList.remove('hidden');
            navChat.classList.remove('hidden');
            languageSwitcher.classList.remove('hidden');
            updateTexts();

            // PDF Export Logic
            exportPdfBtn.addEventListener('click', async () => {
                if (presentation.slides.length === 0) {
                    alert(currentLanguage === 'en' ? 'There are no slides to export.' : 'N√£o h√° slides para exportar.');
                    return;
                }
                const doc = new jspdf.jsPDF('p', 'pt', 'a4');
                const margin = 20;
                let y = margin;
                
                for (let i = 0; i < presentation.slides.length; i++) {
                    const slide = presentation.slides[i];
                    
                    if (i > 0) {
                        doc.addPage();
                        y = margin;
                    }

                    const titleText = slide.title;
                    const bodyText = slide.body;

                    doc.setFontSize(24);
                    doc.text(titleText, margin, y);
                    y += 30;
                    
                    doc.setFontSize(12);
                    const splitText = doc.splitTextToSize(bodyText, 550);
                    doc.text(splitText, margin, y);
                }
                
                doc.save(currentLanguage === 'en' ? 'presentation.pdf' : 'apresentacao.pdf');
                alert(currentLanguage === 'en' ? 'PDF exported successfully!' : 'PDF exportado com sucesso!');
            });

            // Email Logic
            emailProjectBtn.addEventListener('click', () => {
                if (presentation.slides.length === 0) {
                    alert(currentLanguage === 'en' ? 'There are no slides to send.' : 'N√£o h√° slides para enviar.');
                    return;
                }
                const subject = currentLanguage === 'en' ? `AI Slide PRO Project: ${presentation.slides[0].title}` : `Projeto AI Slide PRO: ${presentation.slides[0].title}`;
                let body = currentLanguage === 'en' ? `Hello! I would like to share this slide project with you.\n\n` : `Ol√°! Gostaria de compartilhar este projeto de slides com voc√™.\n\n`;
                presentation.slides.forEach((slide, index) => {
                    body += currentLanguage === 'en' ? `--- Slide ${index + 1} ---\n` : `--- Slide ${index + 1} ---\n`;
                    body += currentLanguage === 'en' ? `Title: ${slide.title}\n` : `T√≠tulo: ${slide.title}\n`;
                    body += currentLanguage === 'en' ? `Content:\n${slide.body}\n\n` : `Conte√∫do:\n${slide.body}\n\n`;
                });
                
                const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.location.href = mailtoLink;
            });


            // Fullscreen Presentation Mode Logic
            const enterPresentationMode = () => {
                if (presentation.slides.length === 0) {
                    alert(currentLanguage === 'en' ? "There are no slides to present." : "N√£o h√° slides para apresentar.");
                    return;
                }

                slidesCarousel.innerHTML = '';
                presentation.slides.forEach((slide, index) => {
                    const slideElement = document.createElement('div');
                    slideElement.className = `fullscreen-slide`;
                    
                    if (slide.backgroundImage) {
                        slideElement.classList.add('with-bg');
                        slideElement.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url(${slide.backgroundImage})`;
                        slideElement.style.color = '#fff';
                    } else {
                         slideElement.style.background = 'linear-gradient(135deg, var(--color-bg-start), var(--color-bg-mid), var(--color-bg-end))';
                         slideElement.style.color = 'var(--color-text-dark)';
                    }
                    const titleHTML = `<h2 class="text-5xl font-bold mb-8">${slide.title}</h2>`;
                    const bodyHTML = `<p class="text-2xl leading-relaxed whitespace-pre-wrap">${slide.body}</p>`;
                    
                    slideElement.innerHTML = titleHTML + bodyHTML;
                    slideElement.style.display = 'none';
                    slidesCarousel.appendChild(slideElement);
                });
                
                fullscreenView.style.display = 'flex';
                presentation.activeSlideIndex = presentation.activeSlideIndex !== -1 ? presentation.activeSlideIndex : 0;
                showCurrentFullscreenSlide();
                showFullscreenControls();
                document.documentElement.requestFullscreen();
            };

            const showCurrentFullscreenSlide = () => {
                const slides = slidesCarousel.querySelectorAll('.fullscreen-slide');
                slides.forEach((slide, index) => {
                    slide.style.display = (index === presentation.activeSlideIndex) ? 'flex' : 'none';
                });
                slideCounter.textContent = `${presentation.activeSlideIndex + 1} / ${presentation.slides.length}`;
            };

            const handleSlideNavigation = (direction) => {
                if (direction === 'next' && presentation.activeSlideIndex < presentation.slides.length - 1) {
                    presentation.activeSlideIndex++;
                } else if (direction === 'prev' && presentation.activeSlideIndex > 0) {
                    presentation.activeSlideIndex--;
                }
                showCurrentFullscreenSlide();
            };

            const showFullscreenControls = () => {
                clearTimeout(controlsTimeout);
                fullscreenControls.classList.add('active');
                controlsTimeout = setTimeout(() => {
                    fullscreenControls.classList.remove('active');
                }, 3000);
            };

            const exitPresentationMode = () => {
                fullscreenView.style.display = 'none';
                clearTimeout(controlsTimeout);
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                }
            };
            
            const handleLaserPointer = (e) => {
                laserPointer.style.left = `${e.clientX}px`;
                laserPointer.style.top = `${e.clientY}px`;
                laserPointer.classList.remove('hidden');
                clearTimeout(laserTimeout);
                laserTimeout = setTimeout(() => {
                    laserPointer.classList.add('hidden');
                }, 1000);
            };

            presentationModeBtn.addEventListener('click', enterPresentationMode);
            prevBtn.addEventListener('click', () => handleSlideNavigation('prev'));
            nextBtn.addEventListener('click', () => handleSlideNavigation('next'));
            exitFullscreenBtn.addEventListener('click', exitPresentationMode);
            fullscreenView.addEventListener('mousemove', handleLaserPointer);

            document.addEventListener('keydown', (e) => {
                if (fullscreenView.style.display === 'flex') {
                    if (e.key === 'ArrowRight') handleSlideNavigation('next');
                    else if (e.key === 'ArrowLeft') handleSlideNavigation('prev');
                    else if (e.key === 'Escape') exitPresentationMode();
                }
            });

            fullscreenView.addEventListener('mousemove', showFullscreenControls);
            fullscreenView.addEventListener('touchstart', showFullscreenControls);
        });
    </script>
</body>
</html>
